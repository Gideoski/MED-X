rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy
     * This ruleset enforces a security model based on structural segregation and explicit roles.
     * Free and premium content are separated into distinct collections to enable fast, secure queries
     * (Query-Ahead Performance or QAP). User-specific data is protected via path-based ownership,
     * ensuring users can only access their own information. A dedicated `/roles_admin` collection
     * provides a clear, efficient mechanism for granting global administrator privileges.
     *
     * Data Structure
     * - `/users/{userId}`: Private user data, keyed by the user's auth UID.
     * - `/creator_profiles/{userId}`: Publicly readable profiles for content creators.
     * - `/roles_admin/{adminId}`: An index of admin UIDs. Document existence grants admin rights.
     * - `/materials_*_free/`: Collections for free content, publicly readable.
     * - `/materials_*_premium/`: Collections for premium content, readable only by subscribers.
     * - `/feedback/{feedbackId}`: A collection for user feedback, writable by users but readable only by admins.
     *
     * Key Security Decisions
     * - User data in `/users` is strictly private to the owner and admins. User listing is disabled.
     * - Admin access is granted globally via an `exists()` check on the `/roles_admin` collection.
     * - Read access to content is determined by the collection path: `_free` collections are public,
     *   while `_premium` collections require a `get()` to the user's profile to verify their `isPremium` status.
     * - Write access for materials is restricted to administrators or the document's owner.
     *
     * Denormalization for Authorization
     * - A user's premium status (`isPremium`) is denormalized onto their `/users/{userId}` document to allow
     *   for an efficient `get()` check for premium content access.
     * - A material's creator (`creatorId`) is denormalized onto the material document itself, enabling simple
     *   ownership checks for updates and deletes without costly joins.
     *
     * Structural Segregation
     * - Instead of a single `/materials` collection with complex filtering rules, content is segregated into four
     *   collections (e.g., `/materials_100lvl_free`, `/materials_100lvl_premium`). This guarantees that all
     *   documents within a collection share the same security posture, making list queries secure and performant.
     */

    // ------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the authenticated user has an admin role by verifying
     * the existence of their UID in the roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Checks if the user is a premium subscriber by reading their own user profile.
     */
    function isPremiumUser() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isPremium == true;
    }

    /**
     * (This function is currently not used in the active rules below but is kept for future implementation of a verification system)
     * Checks if a given creator has been verified by an admin.
     * Requires a 'get' call to the creator's public profile.
     */
    function isVerifiedCreator(creatorId) {
      return get(/databases/$(database)/documents/creator_profiles/$(creatorId)).data.verifiedByAdmin == true;
    }

    // ------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------

    /**
     * @description Stores private user data like email and subscription status.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if (isOwner(userId) || isAdmin()) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if (isOwner(userId) || isAdmin()) && resource != null;
    }

    /**
     * @description Manages admin privileges. Document existence grants admin rights.
     * @path /roles_admin/{adminId}
     */
    match /roles_admin/{adminId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores public-facing profiles for content creators.
     * @path /creator_profiles/{userId}
     */
    match /creator_profiles/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if (isOwner(userId) || isAdmin()) && resource != null && request.resource.data.userId == resource.data.userId;
      allow delete: if (isOwner(userId) || isAdmin()) && resource != null;
    }

    /**
     * @description Captures user feedback submissions.
     * @path /feedback/{feedbackId}
     */
    match /feedback/{feedbackId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isSignedIn() && (request.resource.data.userId == null || request.resource.data.userId == request.auth.uid);
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores 100-level educational materials that are designated as free content.
     * @path /materials_100lvl_free/{materialId}
     */
    match /materials_100lvl_free/{materialId} {
        allow get, list: if true;
        allow create: if true;
        allow update: if (isAdmin() || isOwner(resource.data.creatorId)) && resource != null && request.resource.data.creatorId == resource.data.creatorId;
        allow delete: if (isAdmin() || isOwner(resource.data.creatorId)) && resource != null;
    }

    /**
     * @description Stores 100-level educational materials that require a premium subscription.
     * @path /materials_100lvl_premium/{materialId}
     */
    match /materials_100lvl_premium/{materialId} {
        allow get, list: if isPremiumUser() || isAdmin();
        allow create: if true;
        allow update: if (isAdmin() || isOwner(resource.data.creatorId)) && resource != null && request.resource.data.creatorId == resource.data.creatorId;
        allow delete: if (isAdmin() || isOwner(resource.data.creatorId)) && resource != null;
    }
    
    /**
     * @description Stores 200-level educational materials that are designated as free content.
     * @path /materials_200lvl_free/{materialId}
     */
    match /materials_200lvl_free/{materialId} {
        allow get, list: if true;
        allow create: if true;
        allow update: if (isAdmin() || isOwner(resource.data.creatorId)) && resource != null && request.resource.data.creatorId == resource.data.creatorId;
        allow delete: if (isAdmin() || isOwner(resource.data.creatorId)) && resource != null;
    }
    
    /**
     * @description Stores 200-level educational materials that require a premium subscription.
     * @path /materials_200lvl_premium/{materialId}
     */
    match /materials_200lvl_premium/{materialId} {
        allow get, list: if isPremiumUser() || isAdmin();
        allow create: if true;
        allow update: if (isAdmin() || isOwner(resource.data.creatorId)) && resource != null && request.resource.data.creatorId == resource.data.creatorId;
        allow delete: if (isAdmin() || isOwner(resource.data.creatorId)) && resource != null;
    }
  }
}
